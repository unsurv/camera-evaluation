<!DOCTYPE html>
<html>

<head>
	<title>unsurv eval</title>
	<link rel="shortcut icon" type="image/png" href="favicon.png">

	<link rel="stylesheet" charset="utf-8" href="leaflet/leaflet.css" />
	<script type="text/javascript" charset="utf-8" src="leaflet/leaflet.js"></script>




	<script>
		// Leaflet
		var map;

		var cameras = [];
		var markers = [];

		var osmCameras = [];
		var osmMarkers = [];


		function onLoad() {

			map = L.map('mapid').setView([50.00, 8.26], 16);

			// uncomment this to use openstreetmap.de tiles instead of self rendered tiles
			// have a look at the usage policy beforehand https://www.openstreetmap.de/germanstyle.html

			/*
			L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			*/

			// offline tiles in ./tiles/z/x/y
			L.tileLayer('tiles/{z}/{x}/{y}.png', maxZoom: 18
			}).addTo(map);

		}
	</script>

	<script type="text/javascript" src="map_helper.js"></script>
	<script type="text/javascript" src="csv_reader.js"></script>


	<script>
		// moves through given markers via arrow keys
		// this depends on both arrays "cameras" and "markers" having the same order

		var currentId = 0;

		var currentCamera = cameras[0];

		// keypresses for cycling through markers
		document.onkeydown = checkKey;

		function checkKey(e) {

			var camerasCount = cameras.length;

			e = e || window.event;


			if (e.keyCode == '38') {
				// up arrow
				console.log("+++APPROVED+++");

				console.log(cameras[currentId]);

				// add 1 at end of chosen camera array to indicate ok for upload
				if (cameras[currentId].length == 10) {

					// hasn't been checked before
					cameras[currentId].push("1");
					redrawMarker(currentId);
				} else {
					cameras[currentId][10] = "1";
					redrawMarker(currentId);
				}


				console.log(cameras[currentId]);

			} else if (e.keyCode == '40') {
				// down arrow
				console.log("---DO NOT UPLOAD---");


				// add 0 at end of chosen camera array to indicate do not upload
				if (cameras[currentId].length == 10) {

					// hasn't been checked before
					cameras[currentId].push("0");
					redrawMarker(currentId);
				} else {
					cameras[currentId][10] = "0";
					redrawMarker(currentId);
				}

			} else if (e.keyCode == '37') {
				// left arrow

				console.log("PREVIOUS CAM");


				if (currentId == 0) {
					// move to end of array when pos 0 is reached
					currentId = camerasCount - 1;
				} else {
					currentId -= 1;
				}

				focusView(currentId);


			} else if (e.keyCode == '39') {
				// right arrow

				console.log("NEXT CAM");


				if (currentId == camerasCount - 1) {
					// move to start of array when last position is reached
					currentId = 0;
				} else {
					currentId += 1;
				}

				focusView(currentId);

			}

		}
	</script>

	<script>
		function downloadCsv() {
			var csv = 'TYPE,AREA,DIRECTION,MOUNT,HEIGHT,ANGLE,THUMBNAIL,IMAGE,LAT,LON,UPLOAD\n';
			var data = cameras;

			data.forEach(function(row) {
				csv += row.join(',');
				csv += "\n";
			});

			console.log(csv);
			var hiddenElement = document.createElement('a');
			hiddenElement.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv);
			hiddenElement.target = '_blank';
			hiddenElement.download = Math.random().toString(36).substr(2, 5) + '.csv';
			hiddenElement.click();
		}
	</script>

	<script>
		// download osm cameras from overpass-api.de
		// this data is helpful for determining whether a datapoint already exists in the OSM database

		// https://overpass-api.de/api/interpreter?data=[out:json];node[man_made=surveillance](52.5082248,13.3780064,52.515041,13.3834472);out;

		function downloadOsmData() {

			var mapBounds = map.getBounds();
			var latitudeDistance = Math.abs(mapBounds.getSouth() - mapBounds.getNorth());
			var longitudeDistance = Math.abs(mapBounds.getWest() - mapBounds.getEast());
			console.log(latitudeDistance);
			console.log(longitudeDistance);

			if (latitudeDistance < 0.1 && longitudeDistance < 0.2) { // latitudeDistance ~ 10 km, // longitudeDistance changes with latitude
				var area = [mapBounds.getSouth(), mapBounds.getWest(), mapBounds.getNorth(), mapBounds.getEast()];
				console.log(area.toString());

				fetch("https://overpass-api.de/api/interpreter?data=[out:json];node[man_made=surveillance](" + area.toString() + ");out meta;")
					.then(response => response.json())
					.then(data => {
						console.log(data.elements[0]);

						osmCameras = data.elements;

						populateMap(osmCameras, true);

					});

			} else {
				alert("Please decrease mapsize!");
			}


		}
	</script>


</head>


<body onload="onLoad();">
	<div id="mapid" style="height: 600px;"></div>
	<div><input type="file" id="csvFileInput" onchange="handleFiles(this.files)" accept=".csv"></div>
	<div><button onclick="downloadCsv()">EXPORT CSV</button></div>
	<div><button onclick="downloadOsmData()">Download OSM</button></div>


</body>

</html>
